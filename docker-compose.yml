version: '3.8'
services:
  # 1. PostgreSQL Database
  db:
    image: postgres:16-alpine
    container_name: ghostfolio-db
    restart: always
    environment:
      # These variables define the credentials for the application
      POSTGRES_USER: gf_user_7b3
      POSTGRES_PASSWORD: "KjA!c9$r8Wz@bQpG6" # TEST PASSWORD
      POSTGRES_DB: ghostfolio
    volumes:
      - ghostfolio_db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "gf_user_7b3"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ghostfolio_network

  # 2. Redis Cache
  redis:
    image: redis:7-alpine
    container_name: ghostfolio-redis
    restart: always
    volumes:
      - ghostfolio_redis:/data
    networks:
      - ghostfolio_network

  # 3. Custom Ghostfolio Application (Built from your GitHub Fork)
  app:
    # ðŸ›‘ CRITICAL: The 'build' instruction tells Docker where to get the source code
    build:
      context: https://github.com/mudassarrauf/ghostfolio.git # YOUR FORK URL
      # If your repo is private, you would need to set up SSH keys or a GitHub token here
      args: []
        # Example: Pass any necessary build-time arguments to your Dockerfile
        # BUILD_ENV: production

    container_name: ghostfolio-app
    restart: always
    depends_on:
      db: { condition: service_healthy }
      redis: { condition: service_started }

    environment:
      # --- DATABASE CONNECTION STRING (Using the DB container's name and credentials) ---
      DATABASE_URL: postgresql://gf_user_7b3:KjA!c9$r8Wz@bQpG6@db:5432/ghostfolio?sslmode=prefer

      # --- SECURITY SECRETS (Placeholders for demonstration) ---
      JWT_SECRET_KEY: "RzVf@6Ea&sB9tQhX2mY4jWpL1uZcCkH3"
      ACCESS_TOKEN_SALT: "FhB6gD9jKtL8pQw2rT5vY1xZcCmV0nB3"

      # General Config
      REDIS_HOST: redis
      HOST: 0.0.0.0
      PORT: 3333
      PUID: 1000
      PGID: 1000
      TZ: Asia/Karachi

    ports:
      - "3333"

    networks:
      - ghostfolio_network
      - shared_proxy_network

networks:
  ghostfolio_network:
    driver: bridge
  shared_proxy_network:
    external: true

volumes:
  ghostfolio_db:
  ghostfolio_redis:
